---
import { Carousel } from 'astro-bootstrap';
import type { CarouselSlideType } from 'astro-bootstrap';
import { galleryCollections } from "../data/gallery.js";

// Use passed collection or show all collections
const { collectionId } = Astro.props;

let images = [];
let lightboxCarouselId = 'lightboxCarousel';

if (collectionId) {
  // Show specific collection
  const collection = galleryCollections.find(c => c.id === collectionId);
  if (collection) {
    images = collection.images;
    lightboxCarouselId = `lightboxCarousel-${collectionId}`;
  }
} else {
  // Show all images from all collections
  images = galleryCollections.flatMap(c => c.images);
}

// Compute grid size
const n = Math.ceil(Math.sqrt(images.length));

// Map images to CarouselSlideType for the lightbox carousel
const carouselSlides: CarouselSlideType[] = images.map((img, index) => ({
  img,
  alt: `Gallery image ${index + 1}`,
  active: index === 0,
}));
---

<div style={`display:grid; grid-template-columns:repeat(${n}, 1fr); gap:16px;`}>
  {images.map((img, index) => (
    <div 
      class="gallery-item cursor-pointer transition-transform hover:scale-105"
      data-image-index={index}
      style="width:100%; aspect-ratio:1/1; overflow:hidden; border-radius:8px; border:2px solid #222;"
    >
      <img 
        src={img} 
        alt={`Gallery image ${index + 1}`}
        class="w-full h-full object-cover brightness-95"
        style="width:100%; height:100%; object-fit:cover; filter:brightness(0.95);" 
      />
    </div>
  ))}
</div>

<!-- Lightbox Carousel (hidden by default) -->
<div id="lightbox" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background-color: rgba(0, 0, 0, 0.75);">
  <button 
    id="close-lightbox" 
    class="absolute top-4 right-4 text-white text-4xl hover:opacity-70 z-10"
  >
    Ã—
  </button>
  
  <section class="max-w-6xl mx-auto px-4 w-full" id="lightbox-content">
    <Carousel id={lightboxCarouselId} fade interval={0}>
      <Carousel.Inner>
        {carouselSlides.map((slide) => (
          <Carousel.Item active={slide.active}>
            <div class="flex items-center justify-center" style="min-height: 90vh;">
              <img
                src={slide.img}
                alt={slide.alt}
                class="max-w-full max-h-[90vh] object-contain rounded-lg"
              />
            </div>
          </Carousel.Item>
        ))}
      </Carousel.Inner>
      <Carousel.Controls id={lightboxCarouselId} />
    </Carousel>
  </section>
</div>

<script define:vars={{ images, lightboxCarouselId }}>
  const lightbox = document.getElementById('lightbox');
  const closeBtn = document.getElementById('close-lightbox');
  
  // Open lightbox and navigate to clicked image
  function openLightbox(index) {
    lightbox.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Navigate carousel to clicked image
    const carousel = bootstrap.Carousel.getInstance(document.getElementById(lightboxCarouselId));
    if (carousel) {
      carousel.to(index);
    }
  }
  
  // Close lightbox
  function closeLightbox() {
    lightbox.classList.add('hidden');
    document.body.style.overflow = '';
  }
  
  // Click gallery items to open
  document.querySelectorAll('.gallery-item').forEach((item, index) => {
    item.addEventListener('click', () => openLightbox(index));
  });
  
  // Close button
  closeBtn.addEventListener('click', closeLightbox);
  
  // Close when clicking outside the image/content
  lightbox.addEventListener('click', (e) => {
    const content = document.getElementById('lightbox-content');
    if (content && !content.contains(e.target) && e.target !== closeBtn) {
      closeLightbox();
    }
  });
  
  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !lightbox.classList.contains('hidden')) {
      closeLightbox();
    }
  });
</script>